<script lang="ts">
  import { signer } from "svelte-ethers-store";
  import { ethers, utils, type BigNumberish, type BytesLike } from "ethers";
  import { type ExpressionConfig, rlc } from "@rainprotocol/rainlang";
  import flowExp from "../../../../rain/nft-flow.rain?raw";
  import canTransferExp from "../../../../rain/can-transfer.rain?raw";
  import FlowERC721Artifact from "../../../../rain/FlowERC721.json";
  import CloneFactoryArtifact from "../../../../rain/CloneFactory.json";
  import config from "../../../../rain/contracts.config.json";

  type EvaluableConfigStruct = {
    deployer: string;
    sources: BytesLike[];
    constants: BigNumberish[];
  };
  type FlowERC721ConfigStruct = {
    name: string;
    symbol: string;
    baseURI: string;
    evaluableConfig: EvaluableConfigStruct;
    flowConfig: EvaluableConfigStruct[];
  };

  const deploy = async () => {
    const canTransfer = await rlc(canTransferExp, config.deployerOpmeta);
    const flow = await rlc(flowExp, config.deployerOpmeta);

    const flowERC721Config: FlowERC721ConfigStruct = {
      name: "Flow ERC721",
      symbol: "F721",
      baseURI: "https://www.rainprotocol.xyz/nft/",
      evaluableConfig: {
        deployer: "0x0d41310D0EB1a0E1827D55C98F603263219F8A5d",
        sources: ["0x000d000900180001000d0001", "0x000d0001"],
        constants: [
          "0xfea74d0c9bf4a3c28f0dd0674db22a3d7f8bf259c56af19f4ac1e735b156974f",
          "0xfe90d819490b07580877ce7c3005704048c62af96c6745886d7e356e0b63924a",
          "0x01",
          "0x00",
          "0x01",
        ],
      },
      flowConfig: [
        {
          deployer: "0x0d41310D0EB1a0E1827D55C98F603263219F8A5d",
          sources: [
            "0x000d0001000d000300040000000d0005000d0000000d0000000d0000000d0000000d0002000d0002000d0004000d0006",
          ],
          constants: [
            "0xfea74d0c9bf4a3c28f0dd0674db22a3d7f8bf259c56af19f4ac1e735b156974f",
            "0xfe90d819490b07580877ce7c3005704048c62af96c6745886d7e356e0b63924a",
            "0x00",
          ],
        },
      ],
    };

    console.log(flowERC721Config);

    const encodedConfig = ethers.utils.defaultAbiCoder.encode(
      [
        "tuple(string name, string symbol, string baseURI, tuple(address deployer,bytes[] sources,uint256[] constants) evaluableConfig , tuple(address deployer,bytes[] sources,uint256[] constants)[] flowConfig)",
      ],
      [flowERC721Config]
    );

    const encoded =
      "0x000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000000380000000000000000000000000000000000000000000000000000000000000000b466c6f772045524337323100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000044637323100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002168747470733a2f2f7777772e7261696e70726f746f636f6c2e78797a2f6e66742f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d41310d0eb1a0e1827d55c98f603263219f8a5d00000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000c000d000900180001000d000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000d0001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005fea74d0c9bf4a3c28f0dd0674db22a3d7f8bf259c56af19f4ac1e735b156974ffe90d819490b07580877ce7c3005704048c62af96c6745886d7e356e0b63924a000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000d41310d0eb1a0e1827d55c98f603263219f8a5d00000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000030000d0001000d000300040000000d0005000d0000000d0000000d0000000d0000000d0002000d0002000d0004000d0006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003fea74d0c9bf4a3c28f0dd0674db22a3d7f8bf259c56af19f4ac1e735b156974ffe90d819490b07580877ce7c3005704048c62af96c6745886d7e356e0b63924a0000000000000000000000000000000000000000000000000000000000000000";
    console.log(ethers.utils.hexlify(encodedConfig));
    const cloneFactory = new ethers.Contract(
      "0x276f7A4068d5A59104dD34740EaAd681D1006025",
      CloneFactoryArtifact.abi,
      $signer
    );

    const tx = await cloneFactory.clone(
      "0xC1A8A75Bf931D07AF0A191Faf7A410dfb26Bddab",
      encodedConfig
    );
    const receipt = await tx.wait();
    console.log(receipt);
  };
</script>

<button on:click={deploy}>Deploy</button>
