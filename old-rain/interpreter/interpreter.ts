
import {   hexlify } from "ethers/lib/utils";

import { ExpressionConfig, rlc } from "rainlang";

import { MAGIC_NUMBERS, decodeRainMetaDocument } from "../meta/cbor";



/**
 * @public
 * Builds sources and constants from a rainlang expression.
 *
 * @param expressionString - rainlang expression
 * @returns sources and constants
 */
export const standardEvaluableConfig = async (
  expression: string
): Promise<ExpressionConfig> => {
  const rainDocumentEncoded = "0xff0a89c674ee7874a40059111a789ced5d5b93dbb6157ecfafc0ec78a6762ada2b6dec6cfd96d869eb696c671ca79d8ee307888424cc52844c90da553af9ef3de700bc1312745befeee8c15e490409e03bdfb90038003f7dc3d8ffe01f6367099f8bb397ec2c12a18a44307afee26c60ae44428778e5355d619ce9588682a9091bcb4c339567f89933b8057f614b1ee7823de6c92a9bc964ca54c2b299603ae3e1d593a7c553d542a43c89e0c19fe887a2218dc6c03d6966ef68b4e547a8472691b8619962548aa5824758dd2455f3a7f57bb09558cde5800d9f7fb6bfff3970d71a8b649acdfaaa7d97cfc7222dbb0e7563ad54a569456fc5e703f67d592ffdfd6c4190c922a732452bce163c85566422d53564eaadaca3a3f2341467e5a53fed2753d79f05d079662b19da5f782cb91654c119c992a48d77d13d2d4288c445889fe80ad36a2e5896e649c83311196408114f4a80200148ce1271ddbce1c495237265b0be3c34702ab2fdb815aac52af020d8cd2246865d8cda04fb0565c5139603439019864644974ba605b222136cc8c62bf8a3e51fc294d03dc4393f088af4787f502e7b40b1bdc5ce965d774213ceb84c62995c058b14606ce3f3915f09cdfe2e40eba097ecd78cc7e2870974c5e250922dbca20220514d8af7aa782e7b9ff23016f48cbf6846b550517313964d85cee38c8da107112a6e55cbb1509e40636aba51eb308f22688e46a5c2a699e652716f626b6c7ec06bed6fd511e5c02a091dc54a249ab619cf6c55d7328ed9986826a3fd94c308d429789564e2266b0bfc4da2450a32049db0255828a049a412a545057d282d5ca8e27c9e904853756d0851c86b1beb6a9eb397a984fa77b478e75d44d7e31698e60633ae676d0c7f45888c1ae0658a5d1226924ca6a24295ee7fca7ed36292c76ca252a613bed0339565082be21973d4b47026c22bfa89c55253289483904061d55246a0324e93b413dae70db40f0557259a2ed57c99863f5ab6d559d6a41eddb52714450b9bb2ba4d678a70f92bbf03fb898aa3c0a1e7bf8814283747f4630530452ce400be5a02e128dc32ed37961abf175840cb34d30b11ca89c4586cc5b01a43cfc214681b04d9ef2634c2275dcb289bc1f74a74e9349f836668bcc9443ac86f9909681a94c3dab612a685bd4754c391af19a156f6f12129032ed3338ab9103ec2cd65ba863e755a59b99948484275e82549134cbdbdacfcaececa35959a902d20f9f4d56a04675da1294c5166eed2850b5f5d6809a578da563a424f6d7a58bd405b011761b020bcf5c7d5aa46f1ba674561b91d2be8517f1865f48aa84da6aa327264c1f204b5d1c27c2d4113743e0eaa02a48f55bca4810a1840d58ce576a399830adf9be806f60063e9f52a56c8670f7ebb8dc12e5ca57bee18532b247a790a23660c34712030499c8c8dc4389fb629fbc38f6f9819981bd2d9f0a5a263aca660a2b38280339e4618c6829fd02a165b51718e23941e3250c3a6e85bda256a3239df3a5639ef810a7a832895ad2f3f0678c5899c0aae6732ee0c9b3e185da66b85a16615b58d0dc8c02824c53c86c135079063131045122507086b0634bb0f9abd41db6abfd3e0e6034fa678df271b71d60b846a0ecfa241120dcad2290bd8f06cbda037286ceb993465f25778e891357ac360b19474ff50b1bc8ce2aae8e41f1bf683e2b41886cdee791440276993dd6390dea3838e2ab07741a78a9f51854adf98d0a85963ec093a84e6a1ed591b4e332bc60e0dbf49c38cedbd26b56fb3f3c2627b46a127fffce0fd33a932fa66953a750e9b11ccc55ca5abfea89227c47c437c745a19a7f1549af21553695d218c86a05a481a7b339ab7de3982f4a32635cece4df76a84af4264ab452f25f1f7a232ac64d08602a7566a9d6b9366fb00a26fb68dbae71262df2cd13f716ae8318418122cfc8a5d8930e457a3e72f9ed849e85a785099b3f6a4e981c6c6348de176d020a2d173f0d0db2be4f75f59215d5323220d83e1f0f9f360cc639e80995593b67cfe213202da96b0b3783f7d7885f701a1513ae6371e860a22b72d15eb3033d9d48ec0ce5afbcf51db266fb15a43f5ec3b25dd86dd1d6974e5031fb3b0a3452d29e95e31e1e42add6daf9bce1b4b684ac8e8a076714f3d7347c28f6d28fc843d63a3fe78787decd7f246becadb6e0645cfdfb2d193dd43e83d997b80d8bbe4f4ce86c6c16d609a17c347e7bbd89fd1f9c3b33e3bda920ac04d38672ae371a0f3c522eec45105d2e66a0fd07709dadd91b29ddf0054b10855b7bcbcb37c5042664b6fcb52c4e0eb63796827596277083fd9230b6fd9d5d9ee23bd7bc1fcaf05be87de3cbf185e04ea3aa932161a6bc184195dae20c65b18ba55a839a169d32ce56176b4c492a2821d4cca9a8e7f3f1aeee2c2e0b6930fb354ab41b89663588e38b406e816c71e00cc871b7794f8adc943d479da9dcb175f725cf9a0c993c7fa4939e596d9e5b731e5268a01934fc5533685e811b336b21900fe8748d50086ea4b827ac212751ab16f105fdfe24c6a44e014dc3856e15560a6265d5926943c92a7a900fe53f9623d666bfafbcd07d9ba02aa6b43cb693a3be3f3457fe37bda5edee1ddfc6e6b3b1daa373fc17c1d56f602eb6b7f372d76f50c347d9d286cce1fe892cee7f8e75d9151589bf7aad4ec6b8cc647f756877ad3b0f3b97b19532efd64050565244ee23abeb80cd2eb329afd24060555826bf76609f124b6e38a6d61cc26fc591367ccf9cd3ae1c165393f19c5db1097851a45061f31b076ca4c7616a51b3293c94966b724330335c94c266b65a6d6862070f924afdb596e9be79d94c88624c059c9452c437ef253b727149d8fd709052ed384d14922b765d672ed34653ac43d45c3cbeee4045d619c4de48d88d84281246a9986ef58244239e731a5aa0f2fabafd733910ab82e29cf9e268f8cb4b6db47523caf2f31e37551979d3131790d6381f958a96978d4bb45b19914de953c260cbeb8b8bca8643f70b750f30cf75bf5a68ebc99b021c3866093f285d97d55dcc0e0bf5931938309fe93585db305d759b95d108286de0e604ecb86f67bb53d55791205f96263db23759d98d6d32dd8977aebe932e831b035941a353a565abbb6879e7b377d83ca1d71e363ef101719053ab249898268053fc9f028cad4671eb7dc667c22ec7d206c3115565ac08abb83dba27ac56476365994dfd62b40672053f23e4152bf7fff56f72900a6cb52b177dbd1d9ecf30ed6398a8f334c77c3620d0d33d565eae4234e2a57539c460056a790cd9bac88c3deedbfcac9934ebe483d4a9ec814649da824c0b51edb045c6d0398cb9887521d681bafc655a08cbc85b8911a935313316022d6c2aec8695a346a05d4db69dc29a2261bb926a95af0a94803d959473519d517ee4d7a24442b432b7bca6f06c75f7280929eeb032981bb386cb986585b82c7df2f5253f2886900ebf69b7ca42dd6c59e1368ab4002a365f4f66e60fc34ee5a844e88769e5ebfb69a11e4c4eeef2e2aaf41fa0cb9e0df820997f1815a40b54fc01fede9afa57b964a7cc9791c64aacdc5576a0e82b5bbef62f42823cbcbd60234b84d34e2d5a2be26dd7936aced71b19d5b318e9627ffc2e316f7a88fcfce8f453b827ab8658834da73d1ff8b1b73f0d41e66ddcb9ad3b67942774ee816a43d59f5daa5c35975c4c925569b7b11603cd36fdaad1ef51f5e633658d754a736bf35e9d002ac4323d7a366ea4d017ca4552b9bfb71dc53836e59bda699530e529306742c5a3d02aa5024cd7059af86083059497f05c3b5a7edd781f1203048c30420176ab100c7795bd4c5ca0ec1db3569257788c98d4d776e092cd27190472fce6f6064cd979d2df1bf7cf8f12d0c98d86fafa9c84bf68ac7618e87f418a7c15399cda0a332641c1c0cc498e818ccc927ab8119751503b1a399821b7fec56fb9e2f353628d1dc037ef2c13514b2b316d401f6bf52c4918d9ee7e0600550f77aa66050678b1493120d0bac5246c114867437b702f08ea8190c0836fae8835b4f8e4e07b6d7943402b85dab16501ab310b33c4dcc413d781062b3c053f601e989f32ed73c8d8c557e202445e87c20ee49aad9a4f209cd03c5659a0d29fc5da61ef59198879f3c51e91e9bb80196b14c78ba6aa2c2725d6cc4b79727c5f222f47fa6fa169eee126ca30ab79117709358a94e3aea3a53678c99cbd4551efbded8398b00c1663e7be106b4d806367113223463b1c21886621dacebceaba2e9a701073ffa60339d6fab8a53a1a04f29c42473c193464042f9ea8f1ee92f69f6f8867dcb564f1e3d7a9861ca746e819eba9360eb30cb64b3b3ade13c64cfd84d0d39e3436fcf85ee880af59260c14f3eb8c49db189af838cd5d484c7775e2de3c48212bb4fcc6a60a2a6c3f36d6109d57c4e2b2cf70615d34b030c7df6c466d7d8e15e4133aa90f18b0d7a12e23ab8bcb55971fd017d39f1bb31b27f18261c11f34176d13d68b683ec072ee1d1eca638bb8ed2b59167ab07021682e00956ee8fd663881f9adc7ad24470c51ee78996d3040f86e51a620e9964628ae5aae07fc2e72ad78cc75365f4fbf7b3729382c9ff1caf9886f836853b7e3f7b3812c9bd4482d1d8b62693d012107f2833d4fa1a41dc8eb898ee92f1a48fced4159370015d0ad6ec2cb37bc90893f28862e762ae9c60b2c352a478168cd9a459ce4edb1d345385276c8dd592b665942f8fa89d8e765abcd942e2204523be8640b5c9e6c78beb76a9d5ee58934f5ee49283e0ab5d502742dc6142acf3ec0d9638d3d55ba9ea0796f61853baeaeb5927016f2760949c73a950a59148c74a5d05cb61b0e4807a791a424bda1f3b274994f732baf1586eae6a62717c4103ac7afb5aaf0f79f3beb8f5df23ff70c39cf2b06d5def8bb31fcce22ae2e15d63f37006df1a3fe25ddb2cd5a170f73dcaa14591ba749a97dc8bd39804bb1c05a9987389c3a6c01e32912c2106ed3b67930c822dccd28fff7a87eba71373f4359dffa0f140f823b1cfb4f7200741d193dcddf6400cecedb25731eda5e2d8a00693ee0124a65f1b01a0bf985996eb7e5f54b81828605e59f72b66a21667eff4bcdbc41e608cc7e915dad57455f705438bca46088920bd0c02bdba6fc4319df1e8331ec76559067f432197a23388a12c782cc970846c56cd1a6a85518ab99598830ce17d27eddf55ac7a41708207f1989cac302ab0c716598a05bc388ea409df077cf79dcd8569ab6175f451a95ce6f16c397469e7ede5bcd8ae624f773c85ca574c0d476af0dda0b753d1998d3040b32bb17a661286165ca6e599cb064a0d0e05f35f80a7e63555c5eccf15e6a0360e32ae27f51f9cc4505d7f3853b4c58632cdceecbf6b407761fb4f0a23912e6ebdc73c5f5359e2631bd26322b54528b755565cdf0143d445b7f6671242600a3916aa3b21d63ceb044bb4d49c7c2f3ea3c20f71550b1c23f2385e15efb3c2bd7b329c51e6eeddd9d9fc79c03e5de07fc3f3cdefc5709c03bce3d1bef6bd18a3b2d9db993292dbf14fda6cbed5cc5e6c6d62c00298256132268f35c0a50e5b967ab299dc5730516980bfafdd835fce62109763b114f143243c71fd3b22fc7033e12f8e41f88b3d080f92bd8513d8912bf75b415ac4f798f48be4a4b349aba12065518645452aececd0c8aa89d77915266cc42940f754e058b8a701ef6f123f4ecf11c64e598858845910679d78db719a1f952fa2bd2a67ad4c58ab4c9aeb351773057757bbee0b39422889efaa9c627635880bdf08b68fada227f5ed99353d60d06353db4b46bb8530eb8e272bd6b9afdccf7b3160c3eaa5350377d5aed79dd56ac6222ff154a9012d33e06b5c307fbfafdecb01fbdbfacdb823af7dc4f7e7acd15480a293a6774ece6c214a43eaf2a84c8ca669ff66463f03bd0a6ef129c743c9fd75af1196f6546a7d34f29d84fa33c814397e1023eb50d57c11f1cc42521ad920253979e92e3da07c5916de67de508dd926145f14bd6aab2ca966479d0f12528824aa47498d5e50f2a7cdb893e6840283411f89bf5b4f6260e3a5df5101f866dbb54da2127e8ddafc62bccba36ca4af53c5ad3d595b7bcc6d5675881f993a8cce640d9db1f5606056d5b59fa32b7b8cf80c58fdbb5511f280df7cfee6ffb520bde3011bffe5282f43e495b402706170706c69636174696f6e2f6a736f6e03676465666c617465";

  const dataDecoded = decodeRainMetaDocument(rainDocumentEncoded);

  // Find the correct element related to OPS_META_V1
  const opsMetaMap = dataDecoded.find(
    (elem_) => elem_.get(1) === MAGIC_NUMBERS.OPS_META_V1
  );

  const hexOpsMeta = hexlify(opsMetaMap.get(0));

  return await rlc(expression, hexOpsMeta)
    .then((expressionConfig) => {
      return expressionConfig;
    })
    .catch((error) => {
      throw new Error(JSON.stringify(error, null, 2));
    });
};
